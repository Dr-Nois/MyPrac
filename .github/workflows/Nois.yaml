name: Check out
on: [push, pull_request]
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: 'Dr-Nois/MyPrac' # The repository I'm using 
          ref: 'master' # Current version
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: 'false'
          path: 'my-folder' # This should be a new folder
          clean: 'true'
          fetch-depth: '0' # This is always set as 1, I think 0 is OK.
          fetch-tags: 'true'
          submodules: 'recursive' # This can be 'true', 'false' or 'recursive'


- name: Notify about vulnerabilities
  uses: rtCamp/action-slack-notify@v2
  if: ${{ always() }}
  with:
    status: 'Vulnerabilities Found'
    message: 'Vulnerabilities were found in the code base. Please review the attached report.'
    fields: |
      [
        {"title": "Report", "value": "attachment://trivy-report.json", "short": false}
      ]
    channel: 'your_slack_channel_name'
    attachment: 'trivy-report.json'
    env:
      SLACK_WEBHOOK: ${{ secrets.MySecret }}



- name: Run Trivy vulnerability scanner in fs mode
  uses: aquasecurity/trivy-action@master
  with:
    scan-type: 'fs'
    scan-ref: '.'
    trivy-config: trivy.yaml


- name: Notify about vulnerabilities
  uses: rtCamp/action-slack-notify@v2
  if: ${{ always() }}
  with:
    status: 'Vulnerabilities Found'
    message: 'Vulnerabilities were found in the code base. Please review the attached report.'
    fields: |
      [
        {"title": "Report", "value": "attachment://trivy-report.json", "short": false}
      ]
  env:
    SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  with:
    channel: 'your_slack_channel_name'
    attachment: 'trivy-report.json'
